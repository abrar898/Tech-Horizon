{% extends "base.html" %}

{% block title %}{{ quiz.title }} - LearnHub{% endblock %}

{% block content %}
<div class="container">
    <div class="row justify-content-center">
        <div class="col-lg-8">
            <nav aria-label="breadcrumb" class="mb-3">
                <ol class="breadcrumb">
                    <li class="breadcrumb-item"><a href="{{ url_for('course_detail', course_id=quiz.course_id) }}">{{ quiz.course.title }}</a></li>
                    <li class="breadcrumb-item active" aria-current="page">{{ quiz.title }}</li>
                </ol>
            </nav>

            <div class="card border-0 shadow">
                <div class="card-header bg-primary text-white">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h3 class="card-title mb-0">
                                <i class="fas fa-quiz me-2"></i>{{ quiz.title }}
                            </h3>
                            {% if quiz.description %}
                                <p class="mb-0 opacity-75">{{ quiz.description }}</p>
                            {% endif %}
                        </div>
                        {% if quiz.time_limit_minutes %}
                            <div class="text-end">
                                <div class="badge bg-light text-dark fs-6">
                                    <i class="fas fa-clock me-1"></i>
                                    <span id="timeRemaining">{{ quiz.time_limit_minutes }}:00</span>
                                </div>
                            </div>
                        {% endif %}
                    </div>
                </div>
                
                <div class="card-body">
                    <!-- Quiz Info -->
                    <div class="row mb-4">
                        <div class="col-md-4">
                            <div class="text-center p-3 bg-light rounded">
                                <i class="fas fa-question-circle fa-2x text-primary mb-2"></i>
                                <h6 class="fw-bold">{{ questions|length }}</h6>
                                <small class="text-muted">Questions</small>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="text-center p-3 bg-light rounded">
                                <i class="fas fa-trophy fa-2x text-warning mb-2"></i>
                                <h6 class="fw-bold">{{ quiz.passing_score }}%</h6>
                                <small class="text-muted">Passing Score</small>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="text-center p-3 bg-light rounded">
                                <i class="fas fa-clock fa-2x text-info mb-2"></i>
                                <h6 class="fw-bold">
                                    {% if quiz.time_limit_minutes %}
                                        {{ quiz.time_limit_minutes }} min
                                    {% else %}
                                        No limit
                                    {% endif %}
                                </h6>
                                <small class="text-muted">Time Limit</small>
                            </div>
                        </div>
                    </div>

                    <form method="POST" action="{{ url_for('submit_quiz', quiz_id=quiz.id) }}" id="quizForm">
                        <!-- Progress Bar -->
                        <div class="mb-4">
                            <div class="d-flex justify-content-between mb-2">
                                <span class="text-muted">Progress</span>
                                <span class="text-muted"><span id="currentQuestion">1</span> of {{ questions|length }}</span>
                            </div>
                            <div class="progress" style="height: 8px;">
                                <div class="progress-bar bg-primary" role="progressbar" style="width: 0%" id="progressBar"></div>
                            </div>
                        </div>

                        <!-- Questions -->
                        {% for question in questions %}
                            <div class="question-card card border mb-4" data-question="{{ loop.index }}">
                                <div class="card-body">
                                    <div class="d-flex align-items-start mb-3">
                                        <div class="badge bg-primary me-3" style="min-width: 40px;">{{ loop.index }}</div>
                                        <div class="flex-grow-1">
                                            <h5 class="fw-bold mb-3">{{ question.question_text }}</h5>
                                            
                                            {% if question.question_type == 'multiple_choice' %}
                                                {% if question.options %}
                                                    <div class="row">
                                                        {% for option in question.options %}
                                                            <div class="col-12 mb-2">
                                                                <div class="form-check">
                                                                    <input class="form-check-input" type="radio" 
                                                                           name="question_{{ question.id }}" 
                                                                           id="q{{ question.id }}_{{ loop.index }}" 
                                                                           value="{{ option }}"
                                                                           onchange="updateProgress()">
                                                                    <label class="form-check-label w-100 p-2 rounded" 
                                                                           for="q{{ question.id }}_{{ loop.index }}">
                                                                        <strong>{{ loop.index|chr(64) }}.</strong> {{ option }}
                                                                    </label>
                                                                </div>
                                                            </div>
                                                        {% endfor %}
                                                    </div>
                                                {% endif %}
                                            
                                            {% elif question.question_type == 'true_false' %}
                                                <div class="row">
                                                    <div class="col-md-6 mb-2">
                                                        <div class="form-check">
                                                            <input class="form-check-input" type="radio" 
                                                                   name="question_{{ question.id }}" 
                                                                   id="q{{ question.id }}_true" 
                                                                   value="true"
                                                                   onchange="updateProgress()">
                                                            <label class="form-check-label w-100 p-3 rounded bg-light" for="q{{ question.id }}_true">
                                                                <i class="fas fa-check-circle text-success me-2"></i><strong>True</strong>
                                                            </label>
                                                        </div>
                                                    </div>
                                                    <div class="col-md-6 mb-2">
                                                        <div class="form-check">
                                                            <input class="form-check-input" type="radio" 
                                                                   name="question_{{ question.id }}" 
                                                                   id="q{{ question.id }}_false" 
                                                                   value="false"
                                                                   onchange="updateProgress()">
                                                            <label class="form-check-label w-100 p-3 rounded bg-light" for="q{{ question.id }}_false">
                                                                <i class="fas fa-times-circle text-danger me-2"></i><strong>False</strong>
                                                            </label>
                                                        </div>
                                                    </div>
                                                </div>
                                            
                                            {% elif question.question_type == 'short_answer' %}
                                                <div class="mb-3">
                                                    <textarea class="form-control" name="question_{{ question.id }}" 
                                                              rows="3" placeholder="Type your answer here..."
                                                              onchange="updateProgress()"></textarea>
                                                </div>
                                            {% endif %}
                                            
                                            <div class="mt-3">
                                                <small class="text-muted">
                                                    <i class="fas fa-star me-1"></i>{{ question.points }} point{{ 's' if question.points != 1 else '' }}
                                                </small>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        {% endfor %}

                        <div class="d-flex justify-content-between mt-4">
                            <a href="{{ url_for('course_detail', course_id=quiz.course_id) }}" class="btn btn-outline-secondary">
                                <i class="fas fa-arrow-left me-2"></i>Back to Course
                            </a>
                            <button type="submit" class="btn btn-primary btn-lg" id="submitBtn">
                                <i class="fas fa-check me-2"></i>Submit Quiz
                            </button>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Quiz Instructions -->
            <div class="card border-0 mt-4">
                <div class="card-body bg-light">
                    <h6 class="fw-bold mb-2">
                        <i class="fas fa-info-circle me-2"></i>Quiz Instructions
                    </h6>
                    <ul class="list-unstyled mb-0">
                        <li class="mb-1"><i class="fas fa-check text-success me-2"></i>Answer all questions before submitting</li>
                        <li class="mb-1"><i class="fas fa-check text-success me-2"></i>You need {{ quiz.passing_score }}% to pass this quiz</li>
                        {% if quiz.time_limit_minutes %}
                            <li class="mb-1"><i class="fas fa-check text-success me-2"></i>Complete the quiz within {{ quiz.time_limit_minutes }} minutes</li>
                        {% endif %}
                        <li><i class="fas fa-check text-success me-2"></i>Review your answers before submitting</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
let totalQuestions = {{ questions|length }};
let timeLimit = {% if quiz.time_limit_minutes %}{{ quiz.time_limit_minutes * 60 }}{% else %}null{% endif %};
let timeRemaining = timeLimit;
let timerInterval;

function updateProgress() {
    let answeredQuestions = 0;
    
    // Count answered questions
    for (let i = 1; i <= totalQuestions; i++) {
        const questionInputs = document.querySelectorAll(`[name^="question_"]:nth-of-type(${i})`);
        const questionName = questionInputs[0]?.name;
        if (questionName) {
            const inputs = document.querySelectorAll(`[name="${questionName}"]`);
            let answered = false;
            
            inputs.forEach(input => {
                if ((input.type === 'radio' && input.checked) || 
                    (input.type === 'textarea' && input.value.trim() !== '')) {
                    answered = true;
                }
            });
            
            if (answered) answeredQuestions++;
        }
    }
    
    // Update progress bar
    const progressPercent = (answeredQuestions / totalQuestions) * 100;
    document.getElementById('progressBar').style.width = progressPercent + '%';
    document.getElementById('currentQuestion').textContent = answeredQuestions;
    
    // Update submit button
    const submitBtn = document.getElementById('submitBtn');
    if (answeredQuestions === totalQuestions) {
        submitBtn.classList.remove('btn-outline-primary');
        submitBtn.classList.add('btn-success');
        submitBtn.innerHTML = '<i class="fas fa-check me-2"></i>Submit Quiz';
    } else {
        submitBtn.classList.remove('btn-success');
        submitBtn.classList.add('btn-outline-primary');
        submitBtn.innerHTML = `<i class="fas fa-exclamation-triangle me-2"></i>Answer ${totalQuestions - answeredQuestions} more question${totalQuestions - answeredQuestions !== 1 ? 's' : ''}`;
    }
}

function startTimer() {
    if (!timeLimit) return;
    
    timerInterval = setInterval(function() {
        timeRemaining--;
        
        const minutes = Math.floor(timeRemaining / 60);
        const seconds = timeRemaining % 60;
        
        document.getElementById('timeRemaining').textContent = 
            `${minutes}:${seconds.toString().padStart(2, '0')}`;
        
        // Change color when time is running out
        const timerElement = document.getElementById('timeRemaining').parentElement;
        if (timeRemaining <= 300) { // 5 minutes
            timerElement.classList.remove('bg-light', 'text-dark');
            timerElement.classList.add('bg-warning', 'text-dark');
        }
        if (timeRemaining <= 60) { // 1 minute
            timerElement.classList.remove('bg-warning');
            timerElement.classList.add('bg-danger', 'text-white');
        }
        
        if (timeRemaining <= 0) {
            clearInterval(timerInterval);
            alert('Time is up! Submitting quiz automatically.');
            document.getElementById('quizForm').submit();
        }
    }, 1000);
}

// Form submission confirmation
document.getElementById('quizForm').addEventListener('submit', function(e) {
    const answeredCount = document.getElementById('currentQuestion').textContent;
    
    if (parseInt(answeredCount) < totalQuestions) {
        if (!confirm(`You have only answered ${answeredCount} out of ${totalQuestions} questions. Are you sure you want to submit?`)) {
            e.preventDefault();
            return;
        }
    }
    
    // Disable submit button to prevent double submission
    const submitBtn = document.getElementById('submitBtn');
    submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Submitting...';
    submitBtn.disabled = true;
    
    // Clear timer
    if (timerInterval) {
        clearInterval(timerInterval);
    }
});

// Initialize
document.addEventListener('DOMContentLoaded', function() {
    updateProgress();
    if (timeLimit) {
        startTimer();
    }
    
    // Add click handlers to form-check-labels for better UX
    document.querySelectorAll('.form-check-label').forEach(label => {
        label.addEventListener('click', function() {
            setTimeout(updateProgress, 10);
        });
    });
});

// Prevent accidental page leave
window.addEventListener('beforeunload', function(e) {
    if (document.getElementById('quizForm')) {
        e.preventDefault();
        e.returnValue = '';
    }
});
</script>
{% endblock %}
